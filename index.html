<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevFest Beirut 2025 Registration</title>
    <!-- Import Google Sans Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* General Body Styles */
        body {
            font-family: 'Google Sans', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            line-height: 1.6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        /* Form Container */
        .form-container {
            background: #ffffff;
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
            box-sizing: border-box;
            text-align: center;
        }

        /* Form Title */
        h1 {
            color: #1a73e8; /* Google Blue */
            margin-bottom: 2rem;
            font-size: 2rem;
            text-align: center;
        }

        /* Form Grouping for spacing */
        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        /* Labels for inputs */
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500; /* Adjusted for Google Sans */
            color: #5f6368;
        }

        .label-note {
            display: block;
            font-size: 0.8rem;
            font-weight: 400;
            color: #6c757d;
        }

        /* Input and Select Styling */
        input[type="text"],
        select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1rem;
            background-color: #f8f9fa;
            font-family: 'Google Sans', sans-serif;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.15);
        }
        
        /* Style for readonly inputs */
        input[readonly] {
            background-color: #e9ecef; /* A slightly grayer background */
            cursor: not-allowed;
            color: #6c757d;
        }


        /* Radio Button Styling */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .radio-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 400;
        }
        .radio-group input[type="radio"] {
            margin-right: 0.75rem;
            accent-color: #1a73e8;
            width: 1.15em;
            height: 1.15em;
        }

        /* Submit Button */
        .submit-btn {
            display: block;
            width: 100%;
            padding: 0.85rem;
            background-color: #1a73e8;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-family: 'Google Sans', sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        
        .submit-btn:disabled {
            background-color: #d2e3fc;
            cursor: not-allowed;
        }

        .submit-btn:hover:not(:disabled) {
            background-color: #185abc;
        }

        .submit-btn:active:not(:disabled) {
            transform: translateY(1px);
        }

        /* Loading, Error, and Submission Status States */
        .loading-state, .error-state, #submission-status {
            padding: 2rem 0;
            color: #5f6368;
            font-weight: 500;
        }

        .error-state, #submission-status.error {
            color: #d93025; /* Google Red */
        }

        #submission-status.success {
            color: #1e8e3e; /* Google Green */
        }
    </style>
</head>
<body>

    <div class="form-container">
        <h1>DevFest Beirut 2025</h1>

        <div id="loading-state" class="loading-state">
            <p>Loading your information, please wait...</p>
        </div>
        
        <div id="error-state" class="error-state" style="display: none;">
            <p>Could not load your information. Please check the ID in the URL and try again.</p>
        </div>

        <form id="registration-form" method="post" style="display: none;">
            <!-- Field: Familiarity with Google Developer Tools -->
            <div class="form-group">
                <label for="familiarity_level">How familiar are you with Google Developer Tools?</label>
                <select id="familiarity_level" name="familiarity_level" required>
                    <!-- Options will be populated dynamically -->
                </select>
            </div>

            <!-- Education / Organization Field (Hidden from view) -->
            <div class="form-group" id="follow-up-question" style="display: none;">
                 <label for="education_input">Education / Organization</label>
                 <input type="text" id="education_input" name="education_input" placeholder="e.g., Lebanese American University" readonly>
            </div>
            
            <!-- Optional Participation Question -->
            <div class="form-group" id="participation-question" style="display: none;">
                <label>Do you want to participate in one of the below?
                    <small class="label-note">Laptop mandatory and securing the spot will be early morning. Only 1 spot per person (Timings: 10-12 ; 12:30-14:30 or 15:15-17:15)</small>
                </label>
                <div class="radio-group">
                    <label><input type="radio" name="participation" value="vibathon"> Vibathon</label>
                    <label><input type="radio" name="participation" value="workshop"> Workshop</label>
                    <label><input type="radio" name="participation" value="none" checked> I will attend Talks only</label>
                </div>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="submit-btn" disabled>Submit Application</button>
        </form>
        <div id="submission-status"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Form Elements
            const loadingState = document.getElementById('loading-state');
            const errorState = document.getElementById('error-state');
            const registrationForm = document.getElementById('registration-form');
            const selectElement = document.getElementById('familiarity_level');
            const followUpQuestion = document.getElementById('follow-up-question');
            const participationQuestion = document.getElementById('participation-question');
            const submitButton = registrationForm.querySelector('.submit-btn');
            const submissionStatus = document.getElementById('submission-status');

            // Data store
            let fetchedUserData = null;

            // --- Data Transformation Logic ---
            
            /**
             * Transforms event registration JSON to survey entry format
             */
            function transformToSurveyEntry(response, ticketId, surveyId = 298020) {
                if (!response || !response.data) throw new Error('Invalid response format');
                const data = response.data;
                const referenceMap = { 'social_media': 'Social media', 'gdg_website': 'Notified by this community', 'friends': 'Recommended by a friend or peer', 'university': 'Recommended by a friend or peer', 'partner': 'Recommended by a friend or peer', 'other_events': 'Other', 'other': 'Other' };
                const experienceHierarchy = { 'bootcamp': 0, 'student': 0, 'undergrad_student': 0, 'post_grad': 0, 'grad_student': 0, 'fresh_grad': 0, 'intern': 1, '0-1': 1, '1-2': 1, '3-5': 2, 'freelancer': 2, 'manager_teamlead': 2, 'cto_ceo': 2, '5-7': 3 };
                const experienceMap = { '0-1': '1 -2 year', '1-2': '1 -2 year', 'intern': '1 -2 year', '3-5': '3-5 years', '5-7': '6-10 years', 'freelancer': '3-5 years', 'manager_teamlead': '3-5 years', 'cto_ceo': '3-5 years', 'bootcamp': 'No experience / Not a developer', 'student': 'No experience / Not a developer', 'undergrad_student': 'No experience / Not a developer', 'post_grad': 'No experience / Not a developer', 'grad_student': 'No experience / Not a developer', 'fresh_grad': 'No experience / Not a developer' };
                let experienceValues = [];
                if (Array.isArray(data.experience)) experienceValues = data.experience;
                else if (typeof data.experience === 'string') experienceValues = data.experience.split(',').map(v => v.trim()).filter(Boolean);
                else if (data.experience) experienceValues = [data.experience];
                let highestExperienceValue = null, highestLevel = -1;
                experienceValues.forEach(exp => { const level = experienceHierarchy[exp]; if (level !== undefined && level > highestLevel) { highestLevel = level; highestExperienceValue = exp; } });
                let field1489910 = 'No experience / Not a developer';
                if (highestExperienceValue) { field1489910 = experienceMap[highestExperienceValue] || field1489910; }
                const field1489909 = referenceMap[data.reference] || 'Other';

                return {
                    ticket: ticketId,
                    first_name: data.firstName || '',
                    last_name: data.lastName || '',
                    email: data.email || '',
                    company: data.company || '',
                    event_survey_entry: {
                        survey: surveyId,
                        fields: { '1489908': null, '1489909': field1489909, '1489910': field1489910, '1489911': '1 - Novice', '1489912': '', '1489913': null }
                    },
                    signup_consent: true
                };
            }

            /**
             * Populates a select element with a list of options.
             */
            const populateSelectWithOptions = (options) => {
                selectElement.innerHTML = '';
                const defaultOption = document.createElement('option');
                defaultOption.value = ""; defaultOption.textContent = "Select your familiarity"; defaultOption.disabled = true; defaultOption.selected = true;
                selectElement.appendChild(defaultOption);
                options.forEach(optionText => {
                    const option = document.createElement('option');
                    option.value = optionText.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
                    option.textContent = optionText;
                    selectElement.appendChild(option);
                });
            };

            const fetchAndPopulateForm = async () => {
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    let id = urlParams.get('id');
                    const apiUrl = `https://script.google.com/macros/s/AKfycbzeT95NMjk6bWTw9sHhp0y0VLimBrWliFgyZNpRQtRQHyxl59lYXo_M9zAbupUc-XSX/exec?id=${id}`;
                    
                    const response = await fetch(apiUrl);
                    if (!response.ok) throw new Error(`API request failed with status: ${response.status}`);
                    
                    const responseText = await response.text();
                    let responseData;
                    try { responseData = JSON.parse(responseText); } catch (e) { console.error("Failed to parse API response as JSON:", responseText); throw new Error("API did not return valid JSON."); }
                    
                    const payload = responseData && responseData.status === 'success' ? responseData.data : null;
                    if (!payload) throw new Error("Received invalid data structure from the API.");
                    
                    fetchedUserData = payload; // Store the fetched user data
                    
                    if (Array.isArray(payload.choices)) {
                        populateSelectWithOptions(payload.choices);
                    } else if (payload.id) {
                        const staticChoices = ["1 - Novice", "2 - Fundamental", "3 - Intermediate", "4 - Advanced", "5 - Expert"];
                        populateSelectWithOptions(staticChoices);
                        if (payload.experience === '5-7') selectElement.value = '5_expert';
                        document.getElementById('education_input').value = payload.company || '';
                    } else {
                        throw new Error("Received data is not in a recognized format.");
                    }

                    // Show the form
                    loadingState.style.display = 'none';
                    registrationForm.style.display = 'block';
                    // The "follow-up-question" div containing the company is intentionally kept hidden.
                    participationQuestion.style.display = 'block';
                    submitButton.disabled = false;

                } catch (error) {
                    console.error("Error fetching or populating form:", error);
                    loadingState.style.display = 'none';
                    errorState.style.display = 'block';
                }
            };

            // Event listener for form submission
            registrationForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                if (!fetchedUserData) {
                    submissionStatus.textContent = "Error: Original user data not loaded.";
                    submissionStatus.className = 'error';
                    return;
                }

                submitButton.disabled = true;
                submissionStatus.textContent = "Submitting...";
                submissionStatus.className = '';

                try {
                    const responseData = { status: "success", data: fetchedUserData };
                    const ticketId = 50485; // As per example
                    
                    let postPayload = transformToSurveyEntry(responseData, ticketId);
                    
                    // Update payload with form answers
                    const familiaritySelect = document.getElementById('familiarity_level');
                    const educationInput = document.getElementById('education_input');
                    postPayload.event_survey_entry.fields['1489911'] = familiaritySelect.options[familiaritySelect.selectedIndex].text;
                    postPayload.event_survey_entry.fields['1489912'] = educationInput.value;
                    postPayload.company = educationInput.value; 
                    
                    const submissionApiUrl = 'https://gdg.community.dev/api/event/99354/waitlist/list/';
                    
                    const postResponse = await fetch(submissionApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(postPayload)
                    });

                    if (!postResponse.ok) {
                        const errorText = await postResponse.text();
                        // Directly check the raw text for the specific error message.
                        if (postResponse.status === 400 && errorText.includes("already on the waitlist")) {
                             // Instead of showing a success page, show an error message on the form.
                             submissionStatus.textContent = "This email is already on the waitlist. No further action is required.";
                             submissionStatus.className = 'error'; // Use the existing error class for styling.
                             submitButton.textContent = 'Already on Waitlist'; // Update button text.
                             // Keep the button disabled and the form visible.
                        } else {
                            // For all other errors, throw a generic error to be caught below.
                            throw new Error(`Submission failed: ${postResponse.status} ${errorText}`);
                        }
                    } else {
                        submissionStatus.innerHTML = `
                            <div style="text-align: center;">
                                <p style="font-size: 2.5em; margin-bottom: 1rem;">âœ…</p>
                                <p style="font-weight: bold; font-size: 1.2em;">You are now confirmed to attend DevFest!</p>
                                <p>You will receive an email with your QR Code link.</p>
                                <p style="font-size: 0.9em; color: #5f6368; margin-top: 1.5rem; text-align: left;">
                                    <strong>Please note:</strong> The ticket is not transferable. In case of no-show, you might be restricted from attending future events. Please keep an eye on any communication emails from us.
                                </p>
                            </div>
                        `;
                        submissionStatus.className = 'success';
                        registrationForm.style.display = 'none';
                    }
                    
                } catch (error) {
                    console.error("Submission error:", error);
                    submissionStatus.textContent = `Submission failed. ${error.message}`;
                    submissionStatus.className = 'error';
                    submitButton.disabled = false;
                }
            });

            // Event listener for the participation radio buttons
            document.querySelectorAll('input[name="participation"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    const workshopTimes = document.getElementById('workshop-times');
                    if (workshopTimes) {
                        workshopTimes.style.display = (event.target.value === 'workshop') ? 'block' : 'none';
                    }
                });
            });

            fetchAndPopulateForm();
        });
    </script>

</body>
</html>

